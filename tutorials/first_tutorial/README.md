# KLEE å¿«é€Ÿå…¥é—¨ï¼šæµ‹è¯•ä¸€ä¸ªå°å‡½æ•°

[å®˜æ–¹æ•™ç¨‹](https://klee-se.org/tutorials/testing-function/)

æ¬¢è¿ï¼æœ¬ README é¢å‘ **KLEE**ï¼ˆä¸€ä¸ªåŸºäº LLVM çš„åŠ¨æ€ç¬¦å·æ‰§è¡Œå·¥å…·ï¼‰çš„åˆå­¦è€…ã€‚æˆ‘ä»¬å°†é€šè¿‡ä¸€ä¸ªç®€å•ç¤ºä¾‹ï¼Œå¸¦ä½ äº†è§£ **å¦‚ä½•ç”¨ KLEE è‡ªåŠ¨ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹**ã€‚

---

## 1. ç¤ºä¾‹å‡½æ•°

æˆ‘ä»¬è¦æµ‹è¯•çš„å‡½æ•°å¦‚ä¸‹ï¼Œç”¨äºåˆ¤æ–­æ•´æ•° `x` çš„ç¬¦å·ï¼š

```c
int get_sign(int x) {
  if (x == 0)
    return 0;

  if (x < 0)
    return -1;
  else
    return 1;
}
```

é€»è¾‘ç¤ºæ„å›¾ï¼š

```
        +------+
   x==0 | Yes  | return 0
        +------+
            |
            v
        +-----------+
  x<0?  | Yes       | return -1
        | No        | return 1
        +-----------+
```

KLEE å°†ä¼šæ¢ç´¢è¿™ 3 æ¡è·¯å¾„ï¼Œå¹¶ä¸ºæ¯æ¡è·¯å¾„ç”Ÿæˆä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹ã€‚

â¸»

## 2. ç¼–å†™æµ‹è¯•é©±åŠ¨ï¼ˆtest driverï¼‰

æˆ‘ä»¬éœ€è¦ä¸€ä¸ª main()ï¼ŒæŠŠè¾“å…¥ a å˜æˆç¬¦å·å˜é‡ï¼š

```c
#include <klee/klee.h>

int get_sign(int x);

int main() {
  int a;
  klee_make_symbolic(&a, sizeof(a), "a");
  return get_sign(a);
}
```

è¿™é‡Œçš„ klee_make_symbolic() æ˜¯å…³é”®ï¼š
ğŸ‘‰ å®ƒå‘Šè¯‰ KLEE "æŠŠ a çœ‹ä½œå¯ä»¥å–ä»»ä½•å€¼"ã€‚

â¸»

## 3. ç¼–è¯‘ä¸º LLVM ä½ç 

è¿è¡Œä»¥ä¸‹å‘½ä»¤ç”Ÿæˆ .bc æ–‡ä»¶ï¼š

```bash
$ clang -I ../../include -emit-llvm -c -g -O0 -Xclang -disable-O0-optnone get_sign.c
```

å¾—åˆ° get_sign.bcï¼Œè¿™å°±æ˜¯ KLEE å¯ä»¥æ‰§è¡Œçš„è¾“å…¥ã€‚

â¸»

## 4. è¿è¡Œ KLEE

æ‰§è¡Œï¼š

```bash
$ klee get_sign.bc
```

KLEE ä¼šè¾“å‡ºç±»ä¼¼ç»“æœï¼š

```
KLEE: output directory = "klee-out-0"
KLEE: done: total instructions = 33
KLEE: done: completed paths = 3
KLEE: done: generated tests = 3
```

ç»“æœè§£è¯»ï¼š
* completed paths = 3 ï¼šä¸‰æ¡ä¸åŒæ‰§è¡Œè·¯å¾„
* generated tests = 3 ï¼šä¸‰ä¸ªå¯¹åº”æµ‹è¯•ç”¨ä¾‹

æ•ˆæœå›¾ç¤ºä¾‹ï¼ˆç»ˆç«¯è¾“å‡ºï¼‰ï¼š

ï¼ˆå›¾ç‰‡ä»…ç¤ºæ„ï¼Œå¯èƒ½ä¸å®é™…è¾“å‡ºä¸åŒï¼‰

â¸»

## 5. è¾“å‡ºç›®å½•

KLEE çš„ç»“æœä¿å­˜åœ¨ klee-out-0 æ–‡ä»¶å¤¹ï¼Œç»“æ„å¤§è‡´å¦‚ä¸‹ï¼š

```
klee-out-0/
â”œâ”€â”€ assembly.ll
â”œâ”€â”€ info
â”œâ”€â”€ run.stats
â”œâ”€â”€ run.istats
â”œâ”€â”€ test000001.ktest
â”œâ”€â”€ test000002.ktest
â””â”€â”€ test000003.ktest
```

å…¶ä¸­ï¼š
* test00000X.ktest å°±æ˜¯ç”Ÿæˆçš„æµ‹è¯•ç”¨ä¾‹ï¼›
* run.stats è®°å½•ç»Ÿè®¡æ•°æ®ï¼›
* infoã€messages.txt ç”¨äºè°ƒè¯•å’ŒæŸ¥çœ‹è¿è¡Œä¿¡æ¯ã€‚

KLEE è¿˜ä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ª ç¬¦å·é“¾æ¥ klee-last æŒ‡å‘æœ€æ–°çš„ç»“æœç›®å½•ï¼Œä¾¿äºå¿«é€Ÿè®¿é—®ã€‚

â¸»

## 6. å¯è§†åŒ–è·¯å¾„è¦†ç›–ï¼ˆè¿›é˜¶ï¼‰

ä½ å¯ä»¥ç”¨ ktest-tool æ¥æŸ¥çœ‹æµ‹è¯•ç”¨ä¾‹å†…å®¹ï¼š

```bash
$ ktest-tool klee-last/test000001.ktest
```

è¾“å‡ºç±»ä¼¼ï¼š

```
ktest file : 'klee-last/test000001.ktest'
args       : ['get_sign.bc']
num objects: 1
object 0: name: 'a'
object 0: size: 4
object 0: data: 00 00 00 00
```

è¿™é‡Œ a = 0ï¼Œå¯¹åº” return 0 çš„è·¯å¾„ã€‚

â¸»

## 7. é‡æ–°æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹ï¼ˆReplaying a test caseï¼‰

è™½ç„¶æˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨è¿è¡Œ KLEE ç”Ÿæˆçš„æµ‹è¯•ç”¨ä¾‹ï¼ˆæˆ–ä½¿ç”¨ç°æœ‰æµ‹è¯•æ¡†æ¶ï¼‰ï¼Œä½† KLEE æä¾›äº†ä¾¿æ·çš„é‡æ‰§è¡Œåº“ `libkleeRuntest`ï¼Œå®ƒä¼šå°†å¯¹ `klee_make_symbolic()` çš„è°ƒç”¨æ›¿æ¢ä¸ºä» `.ktest` æ–‡ä»¶ä¸­è¯»å–å€¼çš„å‡½æ•°è°ƒç”¨ã€‚

### ä½¿ç”¨é‡æ‰§è¡Œåº“çš„æ­¥éª¤ï¼š

**â‘  è®¾ç½®åº“è·¯å¾„**
```bash
$ export LD_LIBRARY_PATH=path-to-klee-build-dir/lib/:$LD_LIBRARY_PATH
```

**â‘¡ ç¼–è¯‘åŸç¨‹åºå¹¶é“¾æ¥é‡æ‰§è¡Œåº“**
```bash
$ gcc -I ../../include -L path-to-klee-build-dir/lib/ get_sign.c -lkleeRuntest
```

**â‘¢ ä½¿ç”¨ KTEST_FILE ç¯å¢ƒå˜é‡æŒ‡å®šæµ‹è¯•ç”¨ä¾‹å¹¶è¿è¡Œ**

æµ‹è¯•ç¬¬ä¸€ä¸ªç”¨ä¾‹ï¼ˆa = 0ï¼‰ï¼š
```bash
$ KTEST_FILE=klee-last/test000001.ktest ./a.out
$ echo $?
0
```

æµ‹è¯•ç¬¬äºŒä¸ªç”¨ä¾‹ï¼ˆa = 16843009ï¼Œæ­£æ•°ï¼‰ï¼š
```bash
$ KTEST_FILE=klee-last/test000002.ktest ./a.out
$ echo $?
1
```

æµ‹è¯•ç¬¬ä¸‰ä¸ªç”¨ä¾‹ï¼ˆa = -2147483648ï¼Œè´Ÿæ•°ï¼‰ï¼š
```bash
$ KTEST_FILE=klee-last/test000003.ktest ./a.out
$ echo $?
255
```

### ç»“æœè§£æï¼š
* ç¬¬ä¸€ä¸ªæµ‹è¯•ï¼šè¿”å›å€¼ä¸º 0ï¼ˆè¾“å…¥ä¸º 0ï¼‰
* ç¬¬äºŒä¸ªæµ‹è¯•ï¼šè¿”å›å€¼ä¸º 1ï¼ˆè¾“å…¥ä¸ºæ­£æ•°ï¼‰
* ç¬¬ä¸‰ä¸ªæµ‹è¯•ï¼šè¿”å›å€¼ä¸º 255ï¼ˆ-1 è½¬æ¢ä¸ºæœ‰æ•ˆçš„é€€å‡ºç ï¼ŒèŒƒå›´ 0-255ï¼‰

**é‡è¦æç¤ºï¼š** `libkleeRuntest` åº“ä¼šè‡ªåŠ¨æ›¿æ¢ `klee_make_symbolic()` è°ƒç”¨ï¼Œä»æŒ‡å®šçš„ `.ktest` æ–‡ä»¶ä¸­è¯»å–å…·ä½“çš„æµ‹è¯•å€¼ï¼Œè®©ä½ èƒ½å¤Ÿåœ¨åŸç”Ÿç¯å¢ƒä¸­é‡å¤æ‰§è¡Œ KLEE ç”Ÿæˆçš„æµ‹è¯•åœºæ™¯ã€‚

â¸»

## 8. å­¦ä¹ å°ç»“

| æ­¥éª¤ | å­¦åˆ°çš„çŸ¥è¯† |
|------|------------|
| æµ‹è¯•é©±åŠ¨ | ä½¿ç”¨ klee_make_symbolic() è®©è¾“å…¥å˜æˆç¬¦å·å˜é‡ |
| ç¼–è¯‘ | ç”Ÿæˆ LLVM bitcode .bc æ–‡ä»¶ä¾› KLEE æ‰§è¡Œ |
| è¿è¡Œ | KLEE è‡ªåŠ¨æ¢ç´¢ä¸åŒè·¯å¾„ï¼Œç”Ÿæˆè¦†ç›–å®Œæ•´é€»è¾‘çš„æµ‹è¯•ç”¨ä¾‹ |
| è¾“å‡ºåˆ†æ | æŸ¥çœ‹ .ktest æ–‡ä»¶ï¼Œç†è§£ä¸åŒè·¯å¾„å¯¹åº”çš„è¾“å…¥ |
| é‡æ‰§è¡Œæµ‹è¯• | ä½¿ç”¨ libkleeRuntest åœ¨åŸç”Ÿç¯å¢ƒä¸­éªŒè¯æµ‹è¯•ç”¨ä¾‹ |

â¸»

## 9. ä¸‹ä¸€æ­¥å­¦ä¹ 

å½“ä½ æŒæ¡äº†è¿™ä¸ªå°ä¾‹å­ï¼Œå¯ä»¥ç»§ç»­å­¦ä¹ ï¼š
* ç¬¦å·åŒ–å‘½ä»¤è¡Œå‚æ•°ã€stdinã€æ–‡ä»¶
* KLEE æµ‹è¯•æ­£åˆ™è¡¨è¾¾å¼åº“
* ä½¿ç”¨ KLEE æµ‹è¯• GNU Coreutils

â¸»

æœ€åå¯„è¯­

è¿™å°±æ˜¯ KLEE çš„åŸºæœ¬ç”¨æ³•ï¼š
å†™æµ‹è¯•é©±åŠ¨ â†’ ç¼–è¯‘ â†’ è¿è¡Œ KLEE â†’ å¾—åˆ°è‡ªåŠ¨ç”Ÿæˆçš„æµ‹è¯• â†’ é‡æ‰§è¡ŒéªŒè¯ã€‚

æœ‰äº†å®ƒï¼Œä½ å¯ä»¥è½»æ¾æ¢ç´¢å¤æ‚ç¨‹åºçš„ä¸åŒæ‰§è¡Œè·¯å¾„ï¼ğŸš€

â¸»

ğŸ‘‰ æ›´å¤šæ•™ç¨‹è¯·è§ [KLEEå®˜æ–¹æ•™ç¨‹](https://klee-se.org/docs/#tutorials)ã€‚
