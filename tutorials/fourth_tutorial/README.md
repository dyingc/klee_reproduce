# KLEE è¿›é˜¶æ•™ç¨‹ï¼šä½¿ç”¨ç¬¦å·åŒ–ç¯å¢ƒï¼ˆUsing Symbolic Environmentï¼‰

[å®˜æ–¹æ•™ç¨‹](https://klee-se.org/tutorials/using-symbolic/)

æœ¬æŒ‡å—å°†å¸®åŠ©ä½ ç†è§£ `-sym-arg`, `-sym-args`, `-sym-files`, `-sym-stdin`, `-sym-stdout` ç­‰é€‰é¡¹ï¼Œå­¦ä¼šå¦‚ä½•åœ¨å‘½ä»¤è¡Œå‚æ•°ã€è¾“å…¥æ–‡ä»¶ã€æ ‡å‡†è¾“å…¥/è¾“å‡ºç­‰åœºåˆä¸‹ä½¿ç”¨ç¬¦å·åŒ–æ•°æ®ï¼Œè®© KLEE æ¢ç´¢æ›´å¤šå¯èƒ½çš„æ‰§è¡Œè·¯å¾„ã€‚

â¸»

## 1. æ•™ç¨‹ç›®çš„ä¸èƒŒæ™¯

è®¸å¤šç¨‹åºä¸ä»…ä»æ ‡å‡†è¾“å…¥ï¼ˆstdinï¼‰æˆ–å‘½ä»¤è¡Œå‚æ•°ï¼ˆargvï¼‰è·å¾—è¾“å…¥ï¼Œä¹Ÿå¯èƒ½ä»ç£ç›˜æ–‡ä»¶è¯»å–æ•°æ®ã€‚æŠŠè¿™äº›è¾“å…¥**ç¬¦å·åŒ–ï¼ˆsymbolicï¼‰**ï¼ŒKLEE å°±èƒ½ç³»ç»Ÿæ€§åœ°éå†ä¸åŒè¾“å…¥ç»„åˆï¼Œå‘ç°éšè— bugã€‚å®˜æ–¹æ•™ç¨‹èšç„¦ä¸¤ä¸ªæœ€å¸¸ç”¨çš„é€‰é¡¹ï¼š`-sym-arg` ä¸ `-sym-files`ï¼Œå¹¶é¡ºå¸¦æ¼”ç¤º `-sym-stdin`/`-sym-stdout` çš„åŸºæœ¬ç”¨æ³•ã€‚ ï¿¼

ä¸»è¦å­¦ä¹ å†…å®¹ï¼ˆå®˜æ–¹è¦ç‚¹ï¼‰ï¼š
- **`-sym-arg N`**ï¼šæä¾›ä¸€ä¸ªé•¿åº¦ä¸º N çš„**ç¬¦å·å‘½ä»¤è¡Œå‚æ•°**ï¼ˆè‹¥é…åˆ `-sym-args` å¯ä¸€æ¬¡ç”Ÿæˆå¤šå‚æ•°ï¼‰ã€‚ ï¿¼
- **`-sym-args MIN MAX N`**ï¼šè‡³å°‘ MINã€è‡³å¤š MAX ä¸ªç¬¦å·å‚æ•°ï¼Œæ¯ä¸ªæœ€å¤§é•¿åº¦ Nã€‚ ï¿¼
- **`-sym-files NUM N`**ï¼šåˆ›å»º NUM ä¸ª**ç¬¦å·æ–‡ä»¶**ï¼ˆå‘½åä¾æ¬¡ä¸º `A`,`B`,`C`â€¦ï¼‰ï¼Œæ¯ä¸ªå¤§å° Nã€‚ ï¿¼
- **`-sym-stdin N`**ï¼šè®©**æ ‡å‡†è¾“å…¥**æˆä¸ºå¤§å°ä¸º N çš„ç¬¦å·æ•°æ®ã€‚ ï¿¼
- **`-sym-stdout`**ï¼šè®©**æ ‡å‡†è¾“å‡º**æˆä¸ºç¬¦å·çš„ï¼ˆé€šå¸¸ä¸æ–‡ä»¶/ç®¡é“äº¤äº’ç›¸å…³ï¼‰ã€‚ ï¿¼

> è¿™äº›åŠŸèƒ½éœ€è¦ **`-posix-runtime`**ï¼Œå®ƒä¸ºè¢«æµ‹ç¨‹åºæä¾› POSIX é£æ ¼çš„è¿è¡Œæ—¶ç¯å¢ƒï¼ˆæ–‡ä»¶ã€argvã€stdin/stdout ç­‰ï¼‰ã€‚ ï¿¼

â¸»

## 2. ç¤ºä¾‹ç¨‹åºï¼ˆ`password.c`ï¼Œå‘½ä»¤è¡Œå‚æ•°ç‰ˆï¼‰

æ•™ç¨‹å…ˆç”¨â€œæ£€æŸ¥å¯†ç â€çš„æœ€å°ç¤ºä¾‹æ¼”ç¤º `-sym-arg`ï¼š ï¿¼

```c
#include <stdio.h>

int check_password(char *buf) {
  if (buf[0] == 'h' && buf[1] == 'e' &&
      buf[2] == 'l' && buf[3] == 'l' &&
      buf[4] == 'o')
    return 1;
  return 0;
}

int main(int argc, char **argv) {
  if (argc < 2)
     return 1;

  if (check_password(argv[1])) {
    printf("Password found!\n");
    return 0;
  }
  return 1;
}
```

è¿™ä¸ªç¨‹åºä» argv[1] è¯»å…¥å­—ç¬¦ä¸²å¹¶åˆ¤æ–­æ˜¯å¦ä¸º "hello"ã€‚å¦‚æœæ˜¯ï¼Œå°±æ‰“å° â€œPassword found!â€ã€‚å¦åˆ™ç»“æŸã€‚

â¸»

## 3. ç¼–è¯‘ç¨‹åºåˆ° LLVM Bitcode

è¦ç”¨ KLEE åˆ†æè¯¥ç¨‹åºï¼Œä½ éœ€è¦å…ˆå°†å®ƒç¼–è¯‘æˆ LLVM bitcodeï¼ˆ.bc æ–‡ä»¶ï¼‰ã€‚å…¸å‹æ­¥éª¤å¦‚ä¸‹ï¼š

```bash
clang -emit-llvm -c -g -O0 -Xclang -disable-O0-optnone password.c
```

å‚æ•°è§£é‡Šï¼š
- **-emit-llvm -c**ï¼šç”Ÿæˆ LLVM bitcodeï¼Œä¸é“¾æ¥ä¸ºå¯æ‰§è¡Œæ–‡ä»¶ã€‚
- **-g**ï¼šä¿ç•™è°ƒè¯•ä¿¡æ¯ï¼Œä»¥ä¾¿ KLEE å¯ä»¥ç»™å‡ºæºä»£ç çš„è¡Œå·ç­‰ä¿¡æ¯ã€‚
- **-O0 -Xclang -disable-O0-optnone**ï¼šå…³é—­ä¼˜åŒ–ï¼Œä½†å…è®¸ KLEE è‡ªå·±åšä¸€äº›ä¼˜åŒ–ï¼å¤„ç†ï¼Œä»¥ä¾¿ç¬¦å·æ‰§è¡Œæ›´å‡†ç¡®ï¼å¯æ§ã€‚

â¸»

## 4. ä½¿ç”¨ `-sym-arg` å¯åŠ¨ KLEE

**-sym-arg N** é€‰é¡¹ä½¿å¾—ç¨‹åºçš„ä¸€ä¸ªå‘½ä»¤è¡Œå‚æ•° argv[1] å˜ä¸ºç¬¦å·å­—ç¬¦ä¸²ï¼Œé•¿åº¦ Nã€‚ä¾‹å¦‚ä½ æƒ³è®©è¿™ä¸ªå‚æ•°é•¿åº¦ä¸º 5ï¼š

```bash
klee -posix-runtime password.bc -sym-arg 5
```

KLEE ä¼šæ¢ç´¢å¤šæ¡è·¯å¾„ï¼Œå…¶ä¸­ä¸€æ¡è·¯å¾„ä»¤ç¬¦å·å‚æ•°å…·ä½“åŒ–ä¸º "hello"ï¼Œä»è€Œæ‰“å° Password found! å¹¶ç”Ÿæˆå¯¹åº”æµ‹è¯•ç”¨ä¾‹ã€‚

ä¹Ÿå¯ä»¥ç”¨ `-sym-args MIN MAX N` ä¸€æ¬¡ç”Ÿæˆå¤šä¸ªç¬¦å·å‚æ•°ï¼ˆè‡³å°‘ `MIN`ã€è‡³å¤š `MAX` ä¸ªï¼›æ¯ä¸ªæœ€å¤§é•¿åº¦ `N`ï¼‰ã€‚

æ³¨æ„ï¼š`-posix-runtime` æ˜¯å¿…è¦çš„ï¼Œå› ä¸ºå®ƒè®© KLEE ä½¿ç”¨ä¸€ä¸ª **POSIX**â€å…¼å®¹çš„è¿è¡Œæ—¶æ¥å¤„ç†æ–‡ä»¶ã€è¾“å…¥è¾“å‡ºã€å‘½ä»¤è¡Œå‚æ•°ç­‰ï¼Œè¿™æ · `-sym-arg`, `-sym-files` ç­‰é€‰é¡¹æ‰èƒ½æ­£å¸¸å·¥ä½œã€‚  ï¿¼

è¿è¡Œç»“æœå¯èƒ½ç±»ä¼¼äºï¼š
- KLEE æ¢ç´¢è‹¥å¹²æ¡è·¯å¾„ï¼Œå…¶ä¸­ä¸€æ¡è·¯å¾„èƒ½è®© `argv[1]` æ­£å¥½åŒ¹é… â€œhelloâ€
- KLEE è¾“å‡ºæ¶ˆæ¯ã€ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹ç­‰  ï¿¼

â¸»

## 5. `-sym-files` ç”¨æ³•ï¼ˆå« `-sym-stdin`/`-sym-stdout`ï¼‰

è¿™é‡Œæ˜¯ä¸€ä¸ªæ–°çš„ï¼Œæ–‡ä»¶è¾“å…¥ç‰ˆçš„ password.cï¼Œå¦‚æœå‘½ä»¤è¡Œç»™å‡ºæ–‡ä»¶åå°±ä»è¯¥æ–‡ä»¶è¯»ï¼›å¦åˆ™å›é€€åˆ°æ ‡å‡†è¾“å…¥ï¼š ï¿¼

```c
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <stdio.h>
#include <unistd.h>

int check_password(int fd) {
  char buf[5];
  if (read(fd, buf, 5) != -1) {
    if (buf[0] == 'h' && buf[1] == 'e' &&
        buf[2] == 'l' && buf[3] == 'l' &&
        buf[4] == 'o')
      return 1;
  }
  return 0;
}

int main(int argc, char **argv) {
  int fd;
  if (argc >= 2) {
    if ((fd = open(argv[1], O_RDONLY)) != -1) {
      if (check_password(fd)) {
        printf("Password found in %s\n", argv[1]);
        close(fd);
        return 0;
      }
      close(fd);
      return 1;
    }
  }

  if (check_password(0)) { // 0 == stdin
    printf("Password found in standard input\n");
    return 0;
  }
  return 1;
}
```

### 5.1 ç”¨ `-sym-stdin` é©±åŠ¨æ ‡å‡†è¾“å…¥

å…ˆè®© `stdin` æˆä¸ºç¬¦å·æ•°æ®ï¼ˆä¾‹å¦‚ 10 å­—èŠ‚ï¼‰ï¼Œè¿™æ ·ç¨‹åºå³ä½¿æ²¡æœ‰æˆåŠŸæ‰“å¼€æ–‡ä»¶ä¹Ÿèƒ½ä» `stdin` è¯»å–â€œä»»æ„â€å†…å®¹ï¼š ï¿¼

```bash
clang -emit-llvm -c -g -O0 -Xclang -disable-O0-optnone password.c
klee -posix-runtime password.bc -sym-stdin 10
```

KLEE ä¼šæ¢ç´¢ä¸€æ¡ä½¿å¾— `stdin` å‰ 5 ä¸ªå­—èŠ‚ä¸º "hello" çš„è·¯å¾„ï¼Œå¹¶æ‰“å° **Password found in standard input**ã€‚

### 5.2 ç”¨ `-sym-files` æä¾›ç¬¦å·æ–‡ä»¶

`-sym-files <NUM> <N>` ä¼šåˆ›å»º `NUM` ä¸ªå¤§å°ä¸º `N` çš„ç¬¦å·æ–‡ä»¶ï¼Œè‡ªåŠ¨å‘½åä¸º A,B,Câ€¦
ä¾‹å¦‚åªè¦ 1 ä¸ªå¤§å° 10 çš„æ–‡ä»¶ï¼Œå°±è¿™æ ·å¯åŠ¨ï¼Œå¹¶æŠŠ `A` å½“ä½œå‘½ä»¤è¡Œå‚æ•°ä¼ ç»™ç¨‹åºï¼š

```bash
klee -posix-runtime password.bc A -sym-files 1 10
```

è¿™ä¼šè®©ç¨‹åºä»åä¸º `A` çš„ç¬¦å·æ–‡ä»¶è¯»å–æ•°æ®ï¼›æŸæ¡è·¯å¾„ä¸Šå…¶å‰ `5` å­—èŠ‚å…·ä½“åŒ–ä¸º "hello"ï¼Œä»è€Œæ‰“å° **Password found in A**ã€‚

`-sym-stdout` ä¹Ÿå¯ä»¥ä¸€èµ·ç”¨ï¼ŒæŠŠæ ‡å‡†è¾“å‡ºå½“æˆç¬¦å·åŒ–çš„â€œå¤–éƒ¨äº¤äº’â€ï¼Œä½†åœ¨æœ¬ç¤ºä¾‹ä¸­éå¿…éœ€ã€‚ ï¿¼

â¸»

## 6. å¸¸è§è¾“å‡ºä¸å°è´´å£«
- çœ‹åˆ° *WARNING: undefined reference to function: printf/strlen/strncmp* å±äº POSIX è¿è¡Œæ—¶åŒ…è£¹ä¸å¤–éƒ¨ç¬¦å·çš„æ­£å¸¸æç¤ºï¼›æ•™ç¨‹ç¤ºä¾‹çš„è¿è¡Œè¾“å‡ºä¹ŸåŒ…å«è¿™äº›è¡Œï¼Œæ— éœ€æƒŠæ…Œã€‚ ï¿¼
- è®°å¾—æ¯æ¬¡è¿è¡Œå¯èƒ½ç”Ÿæˆä¸åŒçš„ klee-out-N ç›®å½•ï¼Œå¯é€šè¿‡ klee-last å¿«æ·æŸ¥çœ‹ä¸Šä¸€æ¬¡ç»“æœã€‚
- è‹¥è·¯å¾„çˆ†ç‚¸ï¼Œå¯é…åˆ `--only-output-states-covering-new`, `-max-time`, `-max-forks` ç­‰æ§åˆ¶å¼€é”€ï¼ˆè¿™äº›åœ¨å…¶ä»–æ•™ç¨‹æœ‰è¯¦ç»†ä»‹ç»ï¼‰ã€‚

â¸»

## 7. ç»ƒä¹ å»ºè®®
- ç»ƒä¹  Aï¼šæŠŠ `-sym-args` ä¸ `-sym-files` ç»“åˆï¼Œæ—¢è®©ç¨‹åºæ‹¿åˆ°ä¸€ä¸ªç¬¦å·æ–‡ä»¶åï¼ˆå¦‚ `A`ï¼‰ï¼Œåˆè®©å¦ä¸€ä¸ªå‚æ•°å˜æˆç¬¦å·å­—ç¬¦ä¸²ï¼Œè§‚å¯Ÿè·¯å¾„æ•°ã€‚
- ç»ƒä¹  Bï¼šæŠŠè¯»å–é•¿åº¦æ”¹ä¸ºå¯å˜ï¼ˆä¾‹å¦‚å…ˆè¯»å–ä¸€ä¸ªé•¿åº¦å†è¯»å†…å®¹ï¼‰ï¼Œé…åˆ `-sym-stdin` çº¦æŸè¾“å…¥æ ¼å¼ã€‚
- ç»ƒä¹  Cï¼šåŠ å…¥é”™è¯¯å¤„ç†è·¯å¾„ï¼ˆå¦‚ open å¤±è´¥ã€read è¿”å› -1ï¼‰ï¼Œè§‚å¯Ÿ KLEE å¦‚ä½•åœ¨ä¸åŒç³»ç»Ÿè°ƒç”¨è¿”å›å€¼ä¸Šåˆ†å‰ã€‚

â¸»

ğŸ‘‰ **ä¸‹ä¸€ç«™**ï¼š[æµ‹è¯• GNU Coreutils](https://klee-se.org/tutorials/testing-coreutils/) - åœ¨çœŸå®ä¸–ç•Œçš„ç¨‹åºä¸Šå®æˆ˜ï¼